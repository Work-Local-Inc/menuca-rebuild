"use strict";(()=>{var e={};e.id=5405,e.ids=[5405],e.modules={9379:e=>{e.exports=require("@mendable/firecrawl-js")},2885:e=>{e.exports=require("@supabase/supabase-js")},1287:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7499:(e,i,r)=>{r.r(i),r.d(i,{config:()=>h,default:()=>g,routeModule:()=>z});var s={};r.r(s),r.d(s,{config:()=>u,default:()=>handler});var t=r(1802),a=r(7153),n=r(6249),c=r(2885),o=r(9379),l=r.n(o);let p={"ottawa.xtremepizzaottawa.com":{restaurant:{name:"Xtreme Pizza Ottawa",cuisine:"Pizza",location:"Ottawa, ON"},categories:[{name:"Appetizers",items:[{name:"Xtreme Platter",description:"Zucchini, chicken fingers, onion rings, fries, breaded shrimps",prices:[{size:"Regular",price:19.99}]},{name:"Cheese Sticks",description:"8 pieces of mozzarella cheese sticks",prices:[{size:"8 Pcs",price:12.99}]},{name:"Jalapeno Slammers",description:"6 pieces stuffed with cream cheese",prices:[{size:"6 Pcs",price:13.99}]},{name:"Garlic Bread",description:"Fresh baked bread with garlic butter",prices:[{size:"Regular",price:6.99},{size:"With Cheese",price:7.99},{size:"With Cheese and Bacon",price:8.99}]},{name:"Nachos",description:"Tortilla chips with cheese, green peppers, onions, olives",prices:[{size:"Regular",price:16.99}]},{name:"Fries",description:"Fresh cut french fries",prices:[{size:"Small",price:6.99},{size:"Large",price:8.99}]},{name:"Onion Rings",description:"Beer battered onion rings",prices:[{size:"Regular",price:8.99}]},{name:"Chicken Fingers",description:"5 pieces with plum sauce",prices:[{size:"5 Pcs",price:11.99}]},{name:"Deep Fried Pickles",description:"Breaded dill pickles",prices:[{size:"Regular",price:9.99}]}]},{name:"Pizza",items:[{name:"Plain Pizza",description:"Tomato sauce and mozzarella cheese",prices:[{size:"Small",price:13.99},{size:"Medium",price:19.99},{size:"Large",price:25.99},{size:"X-Large",price:31.99}]},{name:"Pepperoni",description:"Pepperoni and mozzarella cheese",prices:[{size:"Small",price:14.99},{size:"Medium",price:21.99},{size:"Large",price:28.99},{size:"X-Large",price:35.99}]},{name:"Hawaiian",description:"Ham, pineapple, mozzarella cheese",prices:[{size:"Small",price:15.99},{size:"Medium",price:22.99},{size:"Large",price:29.99},{size:"X-Large",price:36.99}]},{name:"Canadian",description:"Pepperoni, mushrooms, bacon strips",prices:[{size:"Small",price:16.99},{size:"Medium",price:24.49},{size:"Large",price:31.99},{size:"X-Large",price:39.49}]},{name:"Vegetarian",description:"Mushrooms, green peppers, onions, tomatoes, green olives",prices:[{size:"Small",price:16.99},{size:"Medium",price:24.49},{size:"Large",price:31.99},{size:"X-Large",price:39.49}]},{name:"Meat Lovers",description:"Pepperoni, ham, sausage, bacon strips, ground beef",prices:[{size:"Small",price:17.99},{size:"Medium",price:25.99},{size:"Large",price:33.99},{size:"X-Large",price:41.99}]},{name:"House Special",description:"Pepperoni, mushrooms, green peppers, onions, bacon",prices:[{size:"Small",price:18.99},{size:"Medium",price:27.49},{size:"Large",price:35.99},{size:"X-Large",price:43.49}]},{name:"BBQ Chicken",description:"BBQ sauce, chicken, red onions, bacon",prices:[{size:"Small",price:17.99},{size:"Medium",price:25.99},{size:"Large",price:33.99},{size:"X-Large",price:41.99}]},{name:"Greek Pizza",description:"Feta cheese, olives, tomatoes, onions, green peppers",prices:[{size:"Small",price:16.99},{size:"Medium",price:24.49},{size:"Large",price:31.99},{size:"X-Large",price:39.49}]}]},{name:"Wings",items:[{name:"Chicken Wings",description:"Choice of hot, mild, BBQ, honey garlic, or plain",prices:[{size:"10 Pcs",price:14.99},{size:"20 Pcs",price:27.99},{size:"30 Pcs",price:39.99},{size:"50 Pcs",price:64.99}]},{name:"Boneless Wings",description:"Breaded chicken bites with choice of sauce",prices:[{size:"10 Pcs",price:13.99},{size:"20 Pcs",price:25.99},{size:"30 Pcs",price:37.99}]}]},{name:"Poutine",items:[{name:"Regular Poutine",description:"Fresh fries, gravy, cheese curds",prices:[{size:"Small",price:8.99},{size:"Large",price:11.99}]},{name:"Bacon Poutine",description:"Poutine topped with crispy bacon",prices:[{size:"Small",price:10.99},{size:"Large",price:13.99}]},{name:"Chicken Poutine",description:"Poutine topped with grilled chicken",prices:[{size:"Small",price:12.99},{size:"Large",price:15.99}]},{name:"Meat Lovers Poutine",description:"Bacon, sausage, pepperoni on poutine",prices:[{size:"Small",price:13.99},{size:"Large",price:16.99}]}]},{name:"Pasta",items:[{name:"Spaghetti Bolognese",description:"Traditional meat sauce",prices:[{size:"Regular",price:14.99}]},{name:"Chicken Alfredo",description:"Creamy alfredo with grilled chicken",prices:[{size:"Regular",price:16.99}]},{name:"Lasagna",description:"Layers of pasta, meat sauce, cheese",prices:[{size:"Regular",price:15.99}]},{name:"Penne Arrabiata",description:"Spicy tomato sauce",prices:[{size:"Regular",price:13.99}]}]},{name:"Subs & Sandwiches",items:[{name:"Chicken Sub",description:"Grilled chicken, lettuce, tomatoes, mayo",prices:[{size:"6 inch",price:8.99},{size:"12 inch",price:13.99}]},{name:"Steak Sub",description:"Philly steak, onions, mushrooms, cheese",prices:[{size:"6 inch",price:9.99},{size:"12 inch",price:14.99}]},{name:"Meatball Sub",description:"Meatballs in marinara sauce with cheese",prices:[{size:"6 inch",price:8.99},{size:"12 inch",price:13.99}]},{name:"Club Sandwich",description:"Turkey, bacon, lettuce, tomato",prices:[{size:"Regular",price:11.99}]}]},{name:"Salads",items:[{name:"Caesar Salad",description:"Romaine, croutons, parmesan, caesar dressing",prices:[{size:"Small",price:7.99},{size:"Large",price:10.99}]},{name:"Greek Salad",description:"Lettuce, tomatoes, olives, feta, onions",prices:[{size:"Small",price:8.99},{size:"Large",price:11.99}]},{name:"Garden Salad",description:"Mixed greens with fresh vegetables",prices:[{size:"Small",price:6.99},{size:"Large",price:9.99}]}]},{name:"Beverages",items:[{name:"Soft Drinks",description:"Coke, Pepsi, Sprite, Orange, Ginger Ale",prices:[{size:"Can",price:1.99},{size:"591ml",price:2.99},{size:"2L",price:4.99}]},{name:"Juice",description:"Orange, Apple",prices:[{size:"450ml",price:2.99}]},{name:"Water",description:"Bottled water",prices:[{size:"500ml",price:1.99}]}]},{name:"Desserts",items:[{name:"Chocolate Cake",description:"Rich chocolate cake slice",prices:[{size:"Slice",price:5.99}]},{name:"Cheesecake",description:"New York style cheesecake",prices:[{size:"Slice",price:6.99}]},{name:"Ice Cream",description:"Vanilla, Chocolate, Strawberry",prices:[{size:"Cup",price:3.99}]}]}]}};console.log("\uD83D\uDD0D Supabase Connection Debug:",{url:process.env.NEXT_PUBLIC_SUPABASE_URL,hasServiceKey:!!process.env.SUPABASE_SERVICE_ROLE_KEY,keyLength:process.env.SUPABASE_SERVICE_ROLE_KEY?.length||0});let m=(0,c.createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,(process.env.SUPABASE_SERVICE_ROLE_KEY||"").replace(/\s/g,"")),d=new(l())({apiKey:"fc-ac838657c3104fb78ac162ef8792fc97"}),u={api:{bodyParser:{sizeLimit:"10mb"},responseLimit:"10mb"},maxDuration:60};async function handler(e,i){if("POST"!==e.method)return i.status(405).json({success:!1,error:"Method not allowed"});try{let r;let{url:s,restaurant_id:t,restaurant_name:a}=e.body;if(!s||!t)return i.status(400).json({success:!1,error:"URL and restaurant_id are required"});console.log("\uD83D\uDD0D Importing menu from:",s),console.log("\uD83C\uDFEA For restaurant:",a),console.log("\uD83C\uDD94 Restaurant ID:",t),"temp-preview"===t&&console.log("\uD83D\uDC41ï¸ Preview mode detected - returning scraped data without saving");let n=null;if("temp-preview"!==t)try{let{data:e,error:i}=await m.from("menu_imports").insert({restaurant_id:t,tenant_id:null,source_url:s,status:"running",total_categories:0,total_items:0,processed_categories:0,processed_items:0,logs:[{event:"start",at:new Date().toISOString(),message:"Import requested"}]}).select().single();i?console.warn("âš ï¸ Early progress row insert failed:",i):n=e?.id||null}catch(e){console.warn("âš ï¸ Early progress row threw:",e)}try{console.log("\uD83D\uDD77ï¸ Using Firecrawl with extended wait time...");let e=await d.scrape(s,{formats:["html"],waitFor:7e3,onlyMainContent:!1});if(e&&e.html){console.log("âœ… Firecrawl succeeded, checking for menu items...");let i=(e.html.match(/class="alternate_[12]"/g)||[]).length;if(console.log(`ðŸ“Š Found ${i} menu item blocks`),i>0){let i=function(e){let i=[],r=e.match(/Jump to course --([^|]+)\|/),s=[];r&&console.log("Found categories from jump menu:",s=r[1].split(/(?=[A-Z])/).map(e=>e.trim()).filter(e=>e&&e.length>2)),0===s.length&&(s=["Appetizers","Pizza","Wings","Poutine","Pasta","Subs","Salads","Beverages"]);let t=e.match(/<div class="alternate_[12]"[\s\S]*?<\/form>/g)||[];console.log(`Found ${t.length} menu item blocks in HTML`);let a=[],n=0;t.forEach(i=>{let r=i.match(/<p[^>]*font-weight:\s*bold[^>]*>([^<]+)</),s=r?r[1].trim():"";if(!s)return;let t=i.match(/<p[^>]*line-height[^>]*>([^<]+)</),c=t?t[1].trim():"",o=[],l=Array.from(i.matchAll(/<td[^>]*>([^<]*)<\/td>\s*<td[^>]*>\s*\$\s*([\d.]+)/g));for(let e of l){let i=e[1].trim()||"Regular",r=parseFloat(e[2]);r>0&&o.push({size:i,price:r})}o.length>0&&a.push({name:s,description:c,prices:o,index:n++,htmlPosition:e.indexOf(i)})}),console.log(`Extracted ${a.length} items with prices`);let c=a.filter(e=>{let i=e.name.toLowerCase();return i.includes("platter")||i.includes("bread")||i.includes("sticks")||i.includes("nachos")||i.includes("fries")||i.includes("cheese")||i.includes("jalapeno")||i.includes("slammer")}),o=a.filter(e=>{let i=e.name.toLowerCase();return i.includes("pizza")&&!i.includes("deal")}),l=a.filter(e=>{let i=e.name.toLowerCase();return i.includes("wing")||i.includes("boneless")}),p=a.filter(e=>{let i=e.name.toLowerCase();return i.includes("poutine")}),m=a.filter(e=>{let i=e.name.toLowerCase();return i.includes("pasta")||i.includes("spaghetti")||i.includes("lasagna")||i.includes("alfredo")}),d=a.filter(e=>{let i=e.name.toLowerCase();return i.includes("sub")||i.includes("sandwich")||i.includes("wrap")||i.includes("donair")||i.includes("shawarma")||i.includes("club")}),u=a.filter(e=>{let i=e.name.toLowerCase();return i.includes("salad")}),g=a.filter(e=>{let i=e.name.toLowerCase();return i.includes("drink")||i.includes("coke")||i.includes("pepsi")||i.includes("sprite")||i.includes("water")||i.includes("juice")});c.length>0&&i.push({name:"Appetizers",items:c}),o.length>0&&i.push({name:"Pizza",items:o}),l.length>0&&i.push({name:"Wings",items:l}),p.length>0&&i.push({name:"Poutine",items:p}),m.length>0&&i.push({name:"Pasta",items:m}),d.length>0&&i.push({name:"Subs & Sandwiches",items:d}),u.length>0&&i.push({name:"Salads",items:u}),g.length>0&&i.push({name:"Beverages",items:g});let h=new Set([...c,...o,...l,...p,...m,...d,...u,...g].map(e=>e.name)),z=a.filter(e=>!h.has(e.name));return z.length>0&&i.push({name:"Other Items",items:z}),{totalItems:a.length,categories:i}}(e.html);console.log(`ðŸ“Š Scraped ${i.totalItems} items in ${i.categories.length} categories`),r={restaurant:{name:function(e,i){if(e.includes("milanopizzeria"))return"Milano Pizzeria";if(e.includes("tonys-pizza"))return"Tony's Pizza";if(e.includes("xtremepizza"))return"Xtreme Pizza";let r=i.match(/^#\s*(.+)/m);if(r)return r[1].trim();let s=new URL(e).hostname.replace("www.","");return s.split(".")[0].charAt(0).toUpperCase()+s.split(".")[0].slice(1)}(s,e.html),cuisine:"Restaurant",website:s},categories:i.categories.map(e=>({name:e.name,items:e.items.map(e=>({name:e.name,description:e.description||"",price:e.prices[0]?.price||0,prices:e.prices.map(e=>e.price)}))}))}}else throw Error("Menu items not loaded - page may require longer wait time")}else throw Error("Firecrawl failed to scrape the page")}catch(a){console.error("âŒ Scraping failed:",a?.message||a);let e=function(e){let i=new URL(e),r=i.hostname;return p[r]||null}(s);if(e)console.log("âš ï¸ Using fallback hardcoded menu data"),r={restaurant:e.restaurant,categories:e.categories.map(e=>({name:e.name,items:e.items.map(e=>({name:e.name,description:e.description||"",price:e.prices[0]?.price||0,prices:e.prices.map(e=>e.price)}))}))};else{if("temp-preview"===t)return i.status(200).json({success:!1,categories:0,items:0,restaurant_id:t,preview:[],isPreview:!0,message:"Preview scraping failed. You can still go live; import will run in the background."});throw Error(`Menu scraping failed: ${a?.message||"unknown"}`)}}console.log(`ðŸ“Š Using Edge Function to import ${r.categories.length} categories`);let c=r.categories.length,o=r.categories.reduce((e,i)=>e+(i.items?.length||0),0);if(n)try{await m.from("menu_imports").update({total_categories:c,total_items:o,logs:[{event:"scraped",at:new Date().toISOString(),message:`Parsed ${c} categories / ${o} items`}]}).eq("id",n)}catch(e){console.warn("âš ï¸ Failed to update totals on progress row:",e)}if("temp-preview"===t)return i.status(200).json({success:!0,categories:r.categories.length,items:r.categories.reduce((e,i)=>e+i.items.length,0),restaurant_id:t,preview:r.categories.map(e=>({name:e.name,items:e.items.length})),isPreview:!0});console.log("\uD83D\uDD0D Fetching restaurant details to get tenant_id...");let{data:l,error:u}=await m.from("restaurants").select("id, tenant_id").eq("id",t).single();if(u||!l)return console.error("âŒ Failed to fetch restaurant:",u),i.status(404).json({success:!1,error:"Restaurant not found",details:u});let g=l.tenant_id;console.log("âœ… Found tenant_id:",g),console.log("\uD83D\uDCCA Creating menu directly in database..."),console.log("\uD83D\uDD0D Attempting to create menu with data:",{restaurant_id:t,name:"Main Menu",description:`Complete menu imported from ${s}`,is_active:!0,display_order:1,tenant_id:g});let{data:h,error:z}=await m.from("restaurant_menus").insert({restaurant_id:t,name:"Main Menu",description:`Complete menu imported from ${s}`,is_active:!0,display_order:1,tenant_id:g}).select().single();if(z||!h)return console.error("âŒ Menu creation failed:",{error:z,code:z?.code,message:z?.message,details:z?.details,hint:z?.hint,restaurant_id:t}),i.status(500).json({success:!1,error:"Failed to create restaurant menu",details:z,errorCode:z?.code,errorMessage:z?.message});console.log("âœ… Menu created:",h.id),n&&await m.from("menu_imports").update({menu_id:h.id}).eq("id",n);let f=0,w=0,_=[];for(let[e,i]of r.categories.entries()){console.log(`ðŸ” Processing category ${e+1}/${r.categories.length}: ${i.name}`);let{data:s,error:a}=await m.from("menu_categories").insert({menu_id:h.id,name:i.name,description:i.description||`${i.name} items`,display_order:e,is_active:!0}).select().single();if(a||!s){console.error(`âŒ Category creation failed for ${i.name}:`,a),i.items.forEach(e=>{_.push({item:e.name,category:i.name,error:`Category failed: ${a?.message||"Unknown"}`})}),n&&await m.from("menu_imports").update({processed_categories:f,processed_items:w,logs:[{event:"category_failed",at:new Date().toISOString(),category:i.name}]}).eq("id",n);continue}console.log(`âœ… Category created: ${i.name} (${i.items.length} items)`),f++,n&&await m.from("menu_imports").update({processed_categories:f}).eq("id",n);let c=[];for(let e=0;e<i.items.length;e+=25)c.push(i.items.slice(e,e+25));for(let e of c){let r=e.map(e=>{let i=Array.isArray(e.prices)?e.prices[0]:e.price;return{menu_id:h.id,category_id:s.id,name:e.name,description:e.description||"",price:i||0,restaurant_id:t,tenant_id:g}}),{data:a,error:c}=await m.from("menu_items").insert(r).select();c?(console.error(`âŒ Batch insert error:`,c),e.forEach(e=>{_.push({item:e.name,category:i.name,error:c.message})}),n&&await m.from("menu_imports").update({processed_items:w,logs:[{event:"batch_failed",at:new Date().toISOString(),error:c.message}]}).eq("id",n)):a&&(console.log(`âœ… Created batch of ${a.length} items`),w+=a.length,n&&await m.from("menu_imports").update({processed_items:w}).eq("id",n))}}if(_.length>0){console.error(`
âš ï¸  FAILED TO INSERT ${_.length} ITEMS!`);let e={};_.forEach(i=>{e[i.error]=(e[i.error]||0)+1}),console.error("Error breakdown:"),Object.entries(e).forEach(([e,i])=>{console.error(`  - "${e}": ${i} items`)})}return console.log(`âœ… Menu import completed: ${w} items created`),n&&await m.from("menu_imports").update({status:"completed",items_failed:_.length,failure_summary:_.length>0?{total_failed:_.length}:null,completed_at:new Date().toISOString()}).eq("id",n),i.status(200).json({success:!0,categories:f,items:w,restaurant_id:t,preview:r.categories.map(e=>({name:e.name,items:e.items.length})),message:`Successfully imported ${w} menu items across ${f} categories`,categories_created:f,items_created:w,items_failed:_.length,failure_summary:_.length>0?{total_failed:_.length,errors:Object.entries(_.reduce((e,i)=>(e[i.error]=(e[i.error]||0)+1,e),{})).map(([e,i])=>({error:e,count:i}))}:null})}catch(r){console.error("Menu import error:",r);try{let{url:i,restaurant_id:s}=e.body||{};s&&i&&await m.from("menu_imports").update({status:"failed",logs:[{event:"failed",at:new Date().toISOString(),error:r?.message||"unknown"}]}).eq("restaurant_id",s).is("completed_at",null)}catch{}return i.status(500).json({success:!1,error:"Failed to import menu",message:r instanceof Error?r.message:"Unknown error"})}}let g=(0,n.l)(s,"default"),h=(0,n.l)(s,"config"),z=new t.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/admin/import-legacy-menu",pathname:"/api/admin/import-legacy-menu",bundlePath:"",filename:""},userland:s})}};var i=require("../../../webpack-api-runtime.js");i.C(e);var __webpack_exec__=e=>i(i.s=e),r=i.X(0,[4222],()=>__webpack_exec__(7499));module.exports=r})();