"use strict";(()=>{var e={};e.id=5405,e.ids=[5405],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},1287:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8400:(e,i,r)=>{r.r(i),r.d(i,{config:()=>g,default:()=>d,routeModule:()=>h});var s={};r.r(s),r.d(s,{default:()=>handler});var t=r(1802),n=r(7153),a=r(6249),o=r(2885);let c=require("@mendable/firecrawl-js");var l=r.n(c);console.log("\uD83D\uDD0D Supabase Connection Debug:",{url:process.env.NEXT_PUBLIC_SUPABASE_URL,hasServiceKey:!!process.env.SUPABASE_SERVICE_ROLE_KEY,keyLength:process.env.SUPABASE_SERVICE_ROLE_KEY?.length||0});let m=(0,o.createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,(process.env.SUPABASE_SERVICE_ROLE_KEY||"").replace(/\s/g,"")),u=new(l())({apiKey:"fc-ac838657c3104fb78ac162ef8792fc97"});function extractPriceFromLine(e){let i=e.match(/\$\s*(\d+\.?\d*)/);return i?parseFloat(i[1]):0}let p={restaurant:{name:"Xtreme Pizza Ottawa",cuisine:"Pizza",location:"Ottawa, ON"},categories:[{name:"Appetizers",items:[{name:"Xtreme Platter",description:"Comes with zucchini, chicken fingers, onion rings, fries and breaded shrimps.",prices:[19.99]},{name:"Cheese Sticks",description:"8 Pcs",prices:[12.99]},{name:"Jalapeno Slammers",description:"6 Pcs",prices:[13.99]},{name:"Garlic Bread",description:"Regular",prices:[6.99,7.99,8.99],sizes:["Regular","With Cheese","With Cheese and Bacon"]},{name:"Nachos",description:"Comes with green peppers, onions and green olives.",prices:[16.99]},{name:"Fries",description:"",prices:[6.99,8.99],sizes:["Small","Large"]}]},{name:"Pizza",items:[{name:"Plain Pizza",description:"",prices:[13.99,19.99,25.99,31.99],sizes:["Small","Medium","Large","X-Large"]},{name:"Margherita",description:"Fresh mozzarella, tomatoes, basil",prices:[15.99,22.99,29.99,36.99],sizes:["Small","Medium","Large","X-Large"]},{name:"Hawaiian",description:"Ham, pineapple",prices:[15.99,22.99,29.99,36.99],sizes:["Small","Medium","Large","X-Large"]},{name:"Canadian",description:"Pepperoni, mushrooms, bacon strips",prices:[16.99,24.49,31.99,39.49],sizes:["Small","Medium","Large","X-Large"]},{name:"Meat Lovers",description:"Pepperoni, ham, sausage, bacon strips",prices:[17.99,25.99,33.99,41.99],sizes:["Small","Medium","Large","X-Large"]},{name:"House Special Pizza",description:"Pepperoni, mushrooms, green peppers, onions, green olives, bacon strips",prices:[18.99,27.49,35.99,43.49],sizes:["Small","Medium","Large","X-Large"]}]},{name:"Wings",items:[{name:"Chicken Wings",description:"Served with choice of red hot, sweet heat, honey garlic, mild, medium, suicide sauce",prices:[14.99,27.99,36.99],sizes:["10 Pcs","20 Pcs","30 Pcs"]},{name:"Boneless Dippers",description:"Served with choice of sauces",prices:[16.99,29.99,38.99],sizes:["10 Pcs","20 Pcs","30 Pcs"]}]},{name:"Poutine",items:[{name:"Regular Poutine",description:"Fresh cut fries with gravy and cheese curds",prices:[8.99]},{name:"Chicken Poutine",description:"Poutine with grilled chicken",prices:[12.99]},{name:"Bacon Poutine",description:"Poutine with crispy bacon",prices:[11.99]}]},{name:"Sandwiches",items:[{name:"Club Sandwich",description:"Triple decker with turkey, bacon, lettuce, tomato",prices:[11.99]},{name:"Chicken Caesar Wrap",description:"Grilled chicken with caesar dressing in a tortilla",prices:[10.99]},{name:"Italian Sub",description:"Ham, salami, pepperoni with italian dressing",prices:[12.99]}]},{name:"Pasta",items:[{name:"Spaghetti Bolognese",description:"Traditional meat sauce over spaghetti",prices:[14.99]},{name:"Chicken Alfredo",description:"Grilled chicken with creamy alfredo sauce",prices:[16.99]},{name:"Lasagna",description:"Layers of pasta, meat sauce, and cheese",prices:[15.99]}]},{name:"Beverages",items:[{name:"Soft Drinks",description:"Coke, Pepsi, Sprite, Orange",prices:[1.5,2.99,4.5],sizes:["Can","591ml","2L"]}]}]};async function handler(e,i){if("POST"!==e.method)return i.status(405).json({success:!1,error:"Method not allowed"});try{let r;let{url:s,restaurant_id:t,restaurant_name:n}=e.body;if(!s||!t)return i.status(400).json({success:!1,error:"URL and restaurant_id are required"});console.log("\uD83D\uDD0D Importing menu from:",s),console.log("\uD83C\uDFEA For restaurant:",n);try{console.log("\uD83D\uDD77Ô∏è Using Firecrawl to scrape menu...");let e=await u.scrape(s,{formats:["markdown","html"],includeTags:["h1","h2","h3","h4","table","div","span","p"],excludeTags:["script","style"],waitFor:3e3});if(e&&(e.markdown||e.html)){if(console.log("‚úÖ Firecrawl succeeded, parsing menu data..."),console.log("\uD83D\uDD0D Scraped data preview:",{markdownLength:e.markdown?.length||0,htmlLength:e.html?.length||0,firstLines:e.markdown?.split("\n").slice(0,20)||[]}),s.includes("milanopizzeria")){console.log("\uD83C\uDF55 Using Milano-specific parser...");let i=function(e){let i=e.split("\n"),r=[],s=null,t=null,n=!1;for(let e=0;e<i.length;e++){let a=i[e].trim();if(!(!a||"|"===a||a.startsWith("| ---"))){if(function(e){return["Menu Pizza","Nos Pizza","Pizza","Nos Poutines","Poutine","Les Sandwiches","Sandwich","Sous-Marin","Nos Nachos","Nachos","Nos P\xe2tes","P\xe2tes","Dessert","Breuvage","Accompagnement","Trempettes","Sp\xe9cial","Offres"].some(i=>e.includes(i))&&e.length<50}(a)&&!n){s&&s.items.length>0&&r.push(s),s={name:a,items:[]},t=null;continue}if(s&&!n&&function(e,i,r){if(e.length<5||e.length>100)return!1;for(let e=r+1;e<Math.min(r+5,i.length);e++)if(i[e].includes("$"))return!0;return!1}(a,i,e)){t&&t.prices.length>0&&s.items.push(t),t={name:a,description:"",prices:[]};continue}if(t&&!n&&a.length>20&&!a.includes("$")){t.description=a;continue}if(a.includes("\xbb ")&&a.includes("$")){n=!0;let e=function(e){let i=e.match(/¬ª\s*([^|]+)\s*\|\s*\$\s*([\d.]+)/);if(i)return{size:i[1].trim(),price:parseFloat(i[2])};let r=e.match(/\$\s*([\d.]+)/);return r?{size:"Regular",price:parseFloat(r[1])}:null}(a);e&&t&&t.prices.push(e)}else n&&!a.includes("$")&&(n=!1)}}return t&&t.prices.length>0&&s&&s.items.push(t),s&&s.items.length>0&&r.push(s),r}(e.markdown||"");r={restaurant:{name:"Milano Pizzeria",cuisine:"Italian Pizza",website:s},categories:i.map(e=>({name:e.name,items:e.items.map(e=>({name:e.name,description:e.description||"",price:e.prices[0]?.price||0,prices:e.prices.map(e=>e.price)}))}))}}else r=function(e,i){console.log("\uD83D\uDD0D Parsing scraped menu data...");try{let r=e.markdown||e.html||"",s=function(e,i){if(e.includes("milanopizzeria"))return"Milano Pizzeria";if(e.includes("tonys-pizza"))return"Tony's Pizza";if(e.includes("xtremepizza"))return"Xtreme Pizza";let r=i.match(/^#\s*(.+)/m);if(r)return r[1].trim();let s=new URL(e).hostname.replace("www.","");return s.split(".")[0].charAt(0).toUpperCase()+s.split(".")[0].slice(1)}(i,r),t=function(e){let i=[],r=e.split("\n"),s=null,t=[];console.log(`üîç Parsing ${r.length} lines of content...`);for(let e=0;e<r.length;e++){let n=r[e].trim();if(!(!n||n.startsWith("|")||n.startsWith("-"))){if(function(e){return!(e.length>50)&&!(e.length<3)&&[/^Sp√©cial/i,/Pizza/i,/Poutine/i,/Sandwich/i,/Nachos/i,/P√¢tes/i,/Dessert/i,/Breuvage/i,/Accompagnement/i,/Trempettes/i,/^Menu/i,/^Offres/i].some(i=>i.test(e))}(n)){s&&t.length>0&&i.push({name:s,items:[...t]}),s=n,t=[];continue}if(s&&function(e,i,r){if(e.includes("$")||e.includes("|")||e.includes("---")||e.toLowerCase().includes("haut")||e.toLowerCase().includes("choisissez"))return!1;for(let e=r+1;e<Math.min(r+5,i.length);e++)if(i[e].includes("$")&&extractPriceFromLine(i[e])>0)return!0;return!1}(n,r,e)){let i=function(e,i){for(let r=i+1;r<Math.min(i+5,e.length);r++){let i=extractPriceFromLine(e[r]);if(i>0)return i}return 0}(r,e);i>0&&t.push({name:n,description:function(e,i){if(i+1<e.length){let r=e[i+1].trim();if(r&&!r.includes("$")&&!r.startsWith("|")&&r.length>10)return r}return""}(r,e),price:i,prices:[i]})}}}return s&&t.length>0&&i.push({name:s,items:t}),i}(r);return console.log(`üìä Extracted ${t.length} categories from scraped data`),{restaurant:{name:s,cuisine:"Restaurant",website:i},categories:t,scraped_at:new Date().toISOString(),source_url:i}}catch(e){throw console.error("‚ùå Error parsing scraped data:",e),e}}(e,s);console.log(`üìä Parsed ${r.categories.length} categories with ${r.categories.reduce((e,i)=>e+(i.items?.length||0),0)} items`),0===r.categories.length&&(console.warn("‚ö†Ô∏è Parser found 0 categories, using Xtreme Pizza fallback data"),r=p)}else throw Error("Firecrawl failed to scrape the menu")}catch(e){console.warn("‚ö†Ô∏è Firecrawl failed, falling back to Xtreme Pizza data:",e.message),r=p}console.log(`üìä Using Edge Function to import ${r.categories.length} categories`),process.env.NEXT_PUBLIC_SUPABASE_URL,r.categories,console.log("\uD83D\uDCCA Step 1: Calling Edge Function for menu import..."),console.log("\uD83D\uDCCA Step 2: Creating menu directly in database...");let{data:a,error:o}=await m.from("restaurant_menus").insert({restaurant_id:t,name:"Main Menu",description:`Complete menu imported from ${s}`,is_active:!0,display_order:1,tenant_id:"default-tenant"}).select().single();if(o||!a)return console.error("‚ùå Menu creation failed:",{error:o,code:o?.code,message:o?.message,details:o?.details,hint:o?.hint,restaurant_id:t}),i.status(500).json({success:!1,error:"Failed to create restaurant menu",details:o,errorCode:o?.code,errorMessage:o?.message});console.log("‚úÖ Menu created:",a.id);let c=0,l=0;for(let[e,i]of r.categories.entries()){console.log(`üîç Processing category ${e+1}/${r.categories.length}: ${i.name}`);let{data:s,error:t}=await m.from("menu_categories").insert({menu_id:a.id,name:i.name,description:i.description||`${i.name} items`,display_order:e,is_active:!0}).select().single();if(t||!s){console.error(`‚ùå Category creation failed for ${i.name}:`,t);continue}for(let[e,r]of(console.log(`‚úÖ Category created: ${i.name} (${i.items.length} items)`),c++,i.items.entries())){let e=Array.isArray(r.prices)?r.prices[0]:r.price,{data:i,error:t}=await m.from("menu_items").insert({category_id:s.id,name:r.name,description:r.description||"",price:e||0,tenant_id:"default-tenant"}).select().single();t?console.error(`‚ùå Item creation error for ${r.name}:`,t):(console.log(`‚úÖ Created item: ${r.name} - $${e}`),l++)}}return console.log(`‚úÖ Menu import completed: ${l} items created`),i.status(200).json({success:!0,categories:c,items:l,restaurant_id:t,preview:r.categories.map(e=>({name:e.name,items:e.items.length})),message:`Successfully imported ${l} menu items across ${c} categories`,categories_created:c,items_created:l})}catch(e){return console.error("Menu import error:",e),i.status(500).json({success:!1,error:"Failed to import menu",message:e instanceof Error?e.message:"Unknown error"})}}let d=(0,a.l)(s,"default"),g=(0,a.l)(s,"config"),h=new t.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/admin/import-legacy-menu",pathname:"/api/admin/import-legacy-menu",bundlePath:"",filename:""},userland:s})}};var i=require("../../../webpack-api-runtime.js");i.C(e);var __webpack_exec__=e=>i(i.s=e),r=i.X(0,[4222],()=>__webpack_exec__(8400));module.exports=r})();