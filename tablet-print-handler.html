<!DOCTYPE html>
<html>
<head>
    <title>MenuCA Print Handler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f0f8ff;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-weight: bold;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .info { background: #cce5ff; border: 1px solid #80bfff; color: #004085; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            font-family: monospace; 
            font-size: 12px; 
            max-height: 300px; 
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #218838; }
        .receipt-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-line;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ®Ô∏è MenuCA Print Handler</h1>
        <p><strong>Status:</strong> <span id="status">Ready</span></p>
        <p><strong>Last Print:</strong> <span id="lastPrint">None</span></p>
        
        <div id="statusBox" class="status info">
            üì° Waiting for print requests from MenuCA orders
        </div>

        <div style="margin: 20px 0;">
            <button onclick="checkForPrintJobs()">üîÑ Check for Print Jobs</button>
            <button onclick="testPrint()">üñ®Ô∏è Test Print</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div>
            <strong>Activity Log:</strong>
            <div id="log" class="log">Print handler ready...\n</div>
        </div>

        <div id="receiptPreview" class="receipt-preview" style="display: none;"></div>
    </div>

    <script>
        let pollInterval;
        let lastReceiptData = null;

        // Start polling for print jobs
        function startPolling() {
            addLog('üîÑ Starting to poll for print jobs every 3 seconds...');
            
            pollInterval = setInterval(() => {
                checkForPrintJobs();
            }, 3000);
        }

        // Check for print jobs by polling a specific endpoint
        async function checkForPrintJobs() {
            try {
                // Try to get print jobs from cloud bridge
                const response = await fetch('/api/printer/tablet-poll', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tabletId: 'xtreme-pizza-tablet-1',
                        lastCheck: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.printJobs && data.printJobs.length > 0) {
                        addLog(`üì® Found ${data.printJobs.length} print job(s)`);
                        data.printJobs.forEach(job => handlePrintJob(job));
                    }
                }
            } catch (error) {
                // Silently fail polling - this is expected when offline
                console.log('Polling failed (expected when offline):', error.message);
            }
        }

        // Handle incoming print job
        function handlePrintJob(job) {
            addLog(`üìã Processing print job for Order #${job.orderData?.orderNumber}`);
            
            lastReceiptData = job.receiptData;
            document.getElementById('lastPrint').textContent = new Date().toLocaleTimeString();
            
            // Show receipt preview
            const preview = document.getElementById('receiptPreview');
            preview.textContent = job.receiptData;
            preview.style.display = 'block';
            
            // Try to print
            printReceipt(job.receiptData);
            
            setStatus('‚úÖ Receipt printed successfully', 'success');
        }

        // Print receipt using Android sharing
        async function printReceipt(receiptData) {
            try {
                addLog('üñ®Ô∏è Attempting to print receipt...');
                
                if (navigator.share && /Android/i.test(navigator.userAgent)) {
                    // Android device - try to share to ESC/POS service
                    await navigator.share({
                        title: 'MenuCA Receipt',
                        text: receiptData
                    });
                    addLog('‚úÖ Receipt shared to ESC/POS Print Service');
                } else {
                    // Fallback - open print dialog
                    const printWindow = window.open('', '_blank', 'width=400,height=600');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>MenuCA Receipt</title>
                            <style>
                                body { 
                                    font-family: monospace; 
                                    font-size: 12px; 
                                    white-space: pre-line; 
                                    margin: 10px;
                                }
                                @media print {
                                    body { font-size: 10px; }
                                }
                            </style>
                        </head>
                        <body>${receiptData}</body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => printWindow.close(), 1000);
                    }, 500);
                    
                    addLog('‚úÖ Opened print dialog');
                }
                
            } catch (error) {
                addLog('‚ùå Print failed: ' + error.message);
                setStatus('‚ùå Print failed', 'error');
            }
        }

        // Test print function
        function testPrint() {
            addLog('üß™ Test print requested');
            const testReceipt = `
                MenuCA Restaurant
                1-800-MENUCA
                ------------------------------------------
                ORDER #TEST001
                ${new Date().toLocaleString()}
                ------------------------------------------
                ITEMS                              PRICE
                1x Test Pizza Large               $18.99
                1x Test Wings                     $12.99
                ------------------------------------------
                Subtotal:                         $31.98
                Tax:                              $4.16
                Delivery:                         $2.99
                ------------------------------------------
                TOTAL:                            $39.13
                ------------------------------------------
                       Thank you for your order!
                       Visit us again soon!
            `;
            
            handlePrintJob({
                orderData: { orderNumber: 'TEST001' },
                receiptData: testReceipt.trim()
            });
        }

        // Utility functions
        function addLog(message) {
            const log = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function setStatus(message, type) {
            const statusBox = document.getElementById('statusBox');
            statusBox.textContent = message;
            statusBox.className = `status ${type}`;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            addLog('Log cleared by user');
        }

        // Initialize
        window.onload = function() {
            addLog('Print handler initialized');
            document.getElementById('status').textContent = 'Active';
            startPolling();
        };

        // Handle URL parameters for direct print requests
        const urlParams = new URLSearchParams(window.location.search);
        const receipt = urlParams.get('receipt');
        if (receipt) {
            addLog('üìß Receipt data found in URL - processing...');
            handlePrintJob({
                orderData: { orderNumber: 'URL-' + Date.now() },
                receiptData: decodeURIComponent(receipt)
            });
        }
    </script>
</body>
</html>