<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçï MenuCA Tablet Print Manager</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }
        
        .status-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .orders-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .order-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid #4CAF50;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .order-number {
            font-size: 18px;
            font-weight: bold;
        }
        
        .order-total {
            font-size: 16px;
            color: #4CAF50;
        }
        
        .order-items {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
        }
        
        .print-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .print-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .print-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .auto-print {
            text-align: center;
            margin: 20px 0;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4CAF50;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .log {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-info { background: rgba(52, 152, 219, 0.2); }
        .log-success { background: rgba(46, 204, 113, 0.2); }
        .log-error { background: rgba(231, 76, 60, 0.2); }
        .log-warning { background: rgba(241, 196, 15, 0.2); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçï MenuCA Tablet Print Manager</h1>
            <p>Xtreme Pizza Ottawa - NETUM Printer Integration</p>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="status-value" id="totalOrders">-</div>
                <div class="status-label">Total Orders</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="pendingOrders">-</div>
                <div class="status-label">Pending</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="completedOrders">-</div>
                <div class="status-label">Printed</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="connectionStatus">üî¥</div>
                <div class="status-label">Connection</div>
            </div>
        </div>
        
        <div class="auto-print">
            <label for="autoPrint">üñ®Ô∏è Auto-Print Mode: </label>
            <label class="toggle-switch">
                <input type="checkbox" id="autoPrint" checked>
                <span class="slider"></span>
            </label>
            <span id="autoPrintStatus">ON</span>
        </div>
        
        <div class="orders-section">
            <h3>üì¶ Pending Print Jobs</h3>
            <div id="ordersContainer">
                <p style="text-align: center; color: rgba(255,255,255,0.7);">
                    Loading print queue...
                </p>
            </div>
        </div>
        
        <div class="orders-section">
            <h3>üìä Activity Log</h3>
            <div class="log" id="activityLog">
                <div class="log-entry log-info">üöÄ MenuCA Print Manager initialized</div>
                <div class="log-entry log-info">üì° Connecting to print queue...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://192.168.0.56:3001/api/printer';
        const RESTAURANT_ID = 'xtreme-pizza';
        const POLL_INTERVAL = 5000; // Poll every 5 seconds
        
        // State
        let isAutoPrintEnabled = true;
        let lastPrintedJobs = new Set();
        let pollInterval;
        
        // DOM Elements
        const totalOrdersEl = document.getElementById('totalOrders');
        const pendingOrdersEl = document.getElementById('pendingOrders');
        const completedOrdersEl = document.getElementById('completedOrders');
        const connectionStatusEl = document.getElementById('connectionStatus');
        const ordersContainerEl = document.getElementById('ordersContainer');
        const autoPrintToggle = document.getElementById('autoPrint');
        const autoPrintStatusEl = document.getElementById('autoPrintStatus');
        const activityLogEl = document.getElementById('activityLog');
        
        // Auto-print toggle
        autoPrintToggle.addEventListener('change', (e) => {
            isAutoPrintEnabled = e.target.checked;
            autoPrintStatusEl.textContent = isAutoPrintEnabled ? 'ON' : 'OFF';
            addLog(isAutoPrintEnabled ? '‚úÖ Auto-print ENABLED' : '‚è∏Ô∏è Auto-print DISABLED', 'info');
        });
        
        // Add log entry
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            activityLogEl.insertBefore(logEntry, activityLogEl.firstChild);
            
            // Keep only last 50 entries
            while (activityLogEl.children.length > 50) {
                activityLogEl.removeChild(activityLogEl.lastChild);
            }
        }
        
        // Poll print queue
        async function pollPrintQueue() {
            try {
                const response = await fetch(`${API_BASE}/queue?restaurantId=${RESTAURANT_ID}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update connection status
                connectionStatusEl.textContent = 'üü¢';
                connectionStatusEl.title = 'Connected to MenuCA Print Queue';
                
                // Update statistics
                totalOrdersEl.textContent = data.totalQueue || 0;
                pendingOrdersEl.textContent = data.pending || 0;
                completedOrdersEl.textContent = data.completed || 0;
                
                // Display pending orders
                displayPendingOrders(data.jobs || []);
                
                // Auto-print new jobs
                if (isAutoPrintEnabled) {
                    const newJobs = data.jobs.filter(job => 
                        job.status === 'pending' && !lastPrintedJobs.has(job.id)
                    );
                    
                    for (const job of newJobs) {
                        await autoPrintJob(job);
                    }
                }
                
            } catch (error) {
                connectionStatusEl.textContent = 'üî¥';
                connectionStatusEl.title = `Connection Error: ${error.message}`;
                addLog(`‚ùå Connection failed: ${error.message}`, 'error');
                
                ordersContainerEl.innerHTML = `
                    <div style="text-align: center; color: rgba(255,255,255,0.7);">
                        ‚ùå Cannot connect to print queue<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        // Display pending orders
        function displayPendingOrders(jobs) {
            const pendingJobs = jobs.filter(job => job.status === 'pending');
            
            if (pendingJobs.length === 0) {
                ordersContainerEl.innerHTML = `
                    <div style="text-align: center; color: rgba(255,255,255,0.7);">
                        ‚úÖ No pending orders - All caught up!
                    </div>
                `;
                return;
            }
            
            ordersContainerEl.innerHTML = pendingJobs.map(job => `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-number">Order #${job.orderData.orderNumber}</div>
                        <div class="order-total">$${job.orderData.total.toFixed(2)}</div>
                    </div>
                    <div class="order-items">
                        ${job.orderData.items.length} items ‚Ä¢ ${job.orderData.customerInfo?.name || 'Customer'}
                    </div>
                    <button class="print-btn" onclick="manualPrintJob('${job.id}')">
                        üñ®Ô∏è Print Receipt
                    </button>
                </div>
            `).join('');
        }
        
        // Auto-print job
        async function autoPrintJob(job) {
            addLog(`üñ®Ô∏è Auto-printing Order #${job.orderData.orderNumber}`, 'info');
            
            try {
                // Create print window with receipt content
                const printWindow = window.open('', '_blank', 'width=300,height=600');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Receipt - Order #${job.orderData.orderNumber}</title>
                        <style>
                            @page { size: 58mm 200mm; margin: 0; }
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 12px; 
                                line-height: 1.2; 
                                margin: 5px; 
                                width: 58mm; 
                                color: black; 
                                background: white; 
                            }
                            .receipt { 
                                white-space: pre-line; 
                                word-wrap: break-word; 
                            }
                            @media print { 
                                body { 
                                    font-size: 10px; 
                                    width: 100%; 
                                    margin: 0; 
                                    padding: 2mm; 
                                } 
                            }
                        </style>
                    </head>
                    <body>
                        <div class="receipt">${job.receiptData}</div>
                        <script>
                            window.onload = function() {
                                setTimeout(function() {
                                    window.print();
                                    setTimeout(function() {
                                        window.close();
                                    }, 1000);
                                }, 500);
                            };
                        </script>
                    </body>
                    </html>
                `);
                
                // Mark job as completed
                await markJobCompleted(job.id);
                lastPrintedJobs.add(job.id);
                
                addLog(`‚úÖ Order #${job.orderData.orderNumber} sent to printer`, 'success');
                
            } catch (error) {
                addLog(`‚ùå Print failed for Order #${job.orderData.orderNumber}: ${error.message}`, 'error');
            }
        }
        
        // Manual print job
        async function manualPrintJob(jobId) {
            const response = await fetch(`${API_BASE}/queue?restaurantId=${RESTAURANT_ID}`);
            const data = await response.json();
            const job = data.jobs.find(j => j.id === jobId);
            
            if (job) {
                await autoPrintJob(job);
            }
        }
        
        // Mark job as completed
        async function markJobCompleted(jobId) {
            try {
                await fetch(`${API_BASE}/queue`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jobId })
                });
            } catch (error) {
                addLog(`‚ö†Ô∏è Failed to mark job ${jobId} as completed`, 'warning');
            }
        }
        
        // Initialize
        function initialize() {
            addLog('üöÄ Starting MenuCA Print Manager...', 'info');
            addLog(`üì° Polling ${API_BASE}/queue every ${POLL_INTERVAL/1000}s`, 'info');
            
            // Start polling
            pollPrintQueue();
            pollInterval = setInterval(pollPrintQueue, POLL_INTERVAL);
            
            addLog('‚úÖ Print Manager ready - Auto-print enabled', 'success');
        }
        
        // Start the application
        initialize();
    </script>
</body>
</html>